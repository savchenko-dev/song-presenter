<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Song Presenter</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        margin: 0;
        background-color: #1a1a1a;
        color: #ffffff;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 280px;
        background-color: #252525;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #333;
      }

      .sidebar-header h2 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .search-input {
        width: 100%;
        padding: 10px 12px;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }

      .search-input:focus {
        border-color: #666;
      }

      .search-input::placeholder {
        color: #888;
      }

      .song-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }

      .song-item {
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.15s;
      }

      .song-item:hover {
        background-color: #333;
      }

      .song-item.active {
        background-color: #3a3a3a;
      }

      .song-title {
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }

      .song-actions {
        display: flex;
        gap: 4px;
        visibility: hidden;
        flex-shrink: 0;
      }

      .song-item:hover .song-actions {
        visibility: visible;
      }

      .song-action-btn {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        transition: all 0.15s;
      }

      .song-action-btn:hover {
        background-color: #444;
        color: #fff;
      }

      .song-action-btn.delete:hover {
        background-color: #c0392b;
      }

      .add-song-btn {
        margin: 12px;
        padding: 12px;
        background-color: #2ecc71;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .add-song-btn:hover {
        background-color: #27ae60;
      }

      .empty-state {
        padding: 20px;
        text-align: center;
        color: #666;
        font-size: 14px;
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
      }

      .controls {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-group label {
        font-size: 13px;
        color: #aaa;
      }

      .control-group input[type="color"] {
        width: 36px;
        height: 28px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: none;
      }

      .control-group input[type="file"] {
        font-size: 13px;
        color: #aaa;
      }

      .editor-container {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #text-input {
        width: 100%;
        flex: 1;
        min-height: 200px;
        background-color: #2c2c2c;
        color: #ffffff;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 16px;
        font-size: 16px;
        font-family: inherit;
        line-height: 1.6;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
      }

      #text-input:focus {
        border-color: #666;
      }

      #text-input::placeholder {
        color: #666;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .modal-overlay.visible {
        display: flex;
      }

      .modal {
        background-color: #2c2c2c;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .modal-close:hover {
        color: #fff;
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #aaa;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 6px;
        color: #fff;
        font-size: 14px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        border-color: #666;
      }

      .form-group textarea {
        min-height: 200px;
        resize: vertical;
        line-height: 1.6;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #333;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-secondary {
        background-color: #444;
        color: #fff;
      }

      .btn-secondary:hover {
        background-color: #555;
      }

      .btn-primary {
        background-color: #2ecc71;
        color: #fff;
      }

      .btn-primary:hover {
        background-color: #27ae60;
      }

      /* Confirm Dialog */
      .confirm-dialog {
        background-color: #2c2c2c;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        text-align: center;
      }

      .confirm-dialog p {
        margin: 0 0 20px 0;
        font-size: 16px;
      }

      .confirm-dialog .btn-group {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .btn-danger {
        background-color: #c0392b;
        color: #fff;
      }

      .btn-danger:hover {
        background-color: #a93226;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background-color: #444;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background-color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>Songs</h2>
          <input
            type="text"
            class="search-input"
            id="song-search"
            placeholder="Search songs..."
          />
        </div>
        <div class="song-list" id="song-list">
          <div class="empty-state">No songs yet. Add your first song!</div>
        </div>
        <button class="add-song-btn" id="add-song-btn">+ Add Song</button>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="controls">
          <div class="control-group">
            <label for="bg-color-picker">Background:</label>
            <input type="color" id="bg-color-picker" value="#121212" />
          </div>
          <div class="control-group">
            <label for="text-color-picker">Text:</label>
            <input type="color" id="text-color-picker" value="#ffffff" />
          </div>
          <div class="control-group">
            <label for="bg-image-picker">Image:</label>
            <input type="file" id="bg-image-picker" accept="image/*" />
          </div>
        </div>

        <div class="editor-container">
          <textarea
            id="text-input"
            placeholder="Start typing lyrics... Click a song in the sidebar to insert it."
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Add/Edit Song Modal -->
    <div class="modal-overlay" id="song-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 id="modal-title">Add Song</h3>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="song-title-input">Title</label>
            <input
              type="text"
              id="song-title-input"
              placeholder="Enter song title..."
            />
          </div>
          <div class="form-group">
            <label for="song-lyrics-input">Lyrics</label>
            <textarea
              id="song-lyrics-input"
              placeholder="Enter lyrics..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="modal-save">Save</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div class="modal-overlay" id="delete-dialog">
      <div class="confirm-dialog">
        <p>Are you sure you want to delete this song?</p>
        <div class="btn-group">
          <button class="btn btn-secondary" id="delete-cancel">Cancel</button>
          <button class="btn btn-danger" id="delete-confirm">Delete</button>
        </div>
      </div>
    </div>

    <script>
      // ============ State ============
      let songs = [];
      let editingSongId = null;
      let deletingSongId = null;

      // ============ DOM Elements ============
      const songList = document.getElementById("song-list");
      const songSearch = document.getElementById("song-search");
      const addSongBtn = document.getElementById("add-song-btn");
      const textarea = document.getElementById("text-input");

      // Modal elements
      const songModal = document.getElementById("song-modal");
      const modalTitle = document.getElementById("modal-title");
      const songTitleInput = document.getElementById("song-title-input");
      const songLyricsInput = document.getElementById("song-lyrics-input");
      const modalClose = document.getElementById("modal-close");
      const modalCancel = document.getElementById("modal-cancel");
      const modalSave = document.getElementById("modal-save");

      // Delete dialog elements
      const deleteDialog = document.getElementById("delete-dialog");
      const deleteCancel = document.getElementById("delete-cancel");
      const deleteConfirm = document.getElementById("delete-confirm");

      // Color pickers
      const bgColorPicker = document.getElementById("bg-color-picker");
      const textColorPicker = document.getElementById("text-color-picker");
      const bgImagePicker = document.getElementById("bg-image-picker");

      // ============ Songs List ============
      async function loadSongs() {
        songs = await window.api.songs.getAll();
        renderSongList(songs);
      }

      async function searchSongs(query) {
        const results = await window.api.songs.search(query);
        renderSongList(results);
      }

      function renderSongList(songsToRender) {
        if (songsToRender.length === 0) {
          songList.innerHTML =
            '<div class="empty-state">No songs found.</div>';
          return;
        }

        songList.innerHTML = songsToRender
          .map(
            (song) => `
          <div class="song-item" data-id="${song.id}">
            <span class="song-title">${escapeHtml(song.title)}</span>
            <div class="song-actions">
              <button class="song-action-btn edit" data-id="${
                song.id
              }">Edit</button>
              <button class="song-action-btn delete" data-id="${
                song.id
              }">Delete</button>
            </div>
          </div>
        `
          )
          .join("");

        // Add click handlers
        songList.querySelectorAll(".song-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            if (!e.target.classList.contains("song-action-btn")) {
              const songId = item.dataset.id;
              const song = songs.find((s) => s.id === songId);
              if (song) {
                // Insert at cursor position
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(textarea.selectionEnd);
                
                textarea.value = textBefore + song.lyrics + textAfter;
                
                // Move cursor to end of inserted text
                const newCursorPos = cursorPos + song.lyrics.length;
                textarea.selectionStart = textarea.selectionEnd = newCursorPos;
                
                textarea.focus();
                updateDisplayText();
                adjustTextareaHeight();
              }
            }
          });
        });

        songList.querySelectorAll(".song-action-btn.edit").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openEditModal(btn.dataset.id);
          });
        });

        songList.querySelectorAll(".song-action-btn.delete").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            openDeleteDialog(btn.dataset.id);
          });
        });
      }

      // Search handler
      songSearch.addEventListener("input", (e) => {
        searchSongs(e.target.value);
      });

      // ============ Modal ============
      function openAddModal() {
        editingSongId = null;
        modalTitle.textContent = "Add Song";
        songTitleInput.value = "";
        songLyricsInput.value = "";
        songModal.classList.add("visible");
        songTitleInput.focus();
      }

      function openEditModal(songId) {
        const song = songs.find((s) => s.id === songId);
        if (!song) return;

        editingSongId = songId;
        modalTitle.textContent = "Edit Song";
        songTitleInput.value = song.title;
        songLyricsInput.value = song.lyrics;
        songModal.classList.add("visible");
        songTitleInput.focus();
      }

      function closeModal() {
        songModal.classList.remove("visible");
        editingSongId = null;
      }

      async function saveSong() {
        const title = songTitleInput.value.trim();
        const lyrics = songLyricsInput.value.trim();

        if (!title) {
          songTitleInput.focus();
          return;
        }

        if (editingSongId) {
          await window.api.songs.update(editingSongId, title, lyrics);
        } else {
          await window.api.songs.create(title, lyrics);
        }

        closeModal();
        await loadSongs();
      }

      addSongBtn.addEventListener("click", openAddModal);
      modalClose.addEventListener("click", closeModal);
      modalCancel.addEventListener("click", closeModal);
      modalSave.addEventListener("click", saveSong);

      // Close modal on escape or outside click
      songModal.addEventListener("click", (e) => {
        if (e.target === songModal) closeModal();
      });

      // ============ Delete Dialog ============
      function openDeleteDialog(songId) {
        deletingSongId = songId;
        deleteDialog.classList.add("visible");
      }

      function closeDeleteDialog() {
        deleteDialog.classList.remove("visible");
        deletingSongId = null;
      }

      async function confirmDelete() {
        if (deletingSongId) {
          await window.api.songs.delete(deletingSongId);
          closeDeleteDialog();
          await loadSongs();
        }
      }

      deleteCancel.addEventListener("click", closeDeleteDialog);
      deleteConfirm.addEventListener("click", confirmDelete);
      deleteDialog.addEventListener("click", (e) => {
        if (e.target === deleteDialog) closeDeleteDialog();
      });

      // ============ Color & Image Pickers ============
      function updateDisplayColors() {
        window.api.sendColors({
          backgroundColor: bgColorPicker.value,
          textColor: textColorPicker.value,
        });
      }

      bgColorPicker.addEventListener("input", updateDisplayColors);
      textColorPicker.addEventListener("input", updateDisplayColors);

      bgImagePicker.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            window.api.sendImage(reader.result);
          };
          reader.readAsDataURL(file);
        }
      });

      // ============ Textarea & Display ============
      function adjustTextareaHeight() {
        const scrollPos =
          document.documentElement.scrollTop || document.body.scrollTop;
        const selStart = textarea.selectionStart;
        const selEnd = textarea.selectionEnd;

        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";

        document.documentElement.scrollTop = document.body.scrollTop =
          scrollPos;
        setTimeout(() => textarea.setSelectionRange(selStart, selEnd), 0);
      }

      function updateDisplayText() {
        const text = textarea.value;
        const cursorPosition = textarea.selectionStart;

        const lines = text.split("\n");
        let currentLineIndex = 0;
        let charCount = 0;

        for (let i = 0; i < lines.length; i++) {
          charCount += lines[i].length + 1;
          if (cursorPosition <= charCount) {
            currentLineIndex = i;
            break;
          }
        }

        let startLine = currentLineIndex;
        while (startLine > 0 && lines[startLine - 1].trim() !== "") {
          startLine--;
        }

        let endLine = currentLineIndex;
        while (endLine < lines.length - 1 && lines[endLine + 1].trim() !== "") {
          endLine++;
        }

        const currentParagraphBlock = lines
          .slice(startLine, endLine + 1)
          .join("\n");
        window.api.sendText(currentParagraphBlock);
        adjustTextareaHeight();
      }

      textarea.addEventListener("input", updateDisplayText);
      textarea.addEventListener("keyup", updateDisplayText);
      textarea.addEventListener("mouseup", updateDisplayText);

      // ============ Utilities ============
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ============ Keyboard Shortcuts ============
      document.addEventListener("keydown", (e) => {
        // Escape to close modals
        if (e.key === "Escape") {
          if (songModal.classList.contains("visible")) {
            closeModal();
          }
          if (deleteDialog.classList.contains("visible")) {
            closeDeleteDialog();
          }
        }

        // Ctrl/Cmd + Enter to save in modal
        if (
          (e.ctrlKey || e.metaKey) &&
          e.key === "Enter" &&
          songModal.classList.contains("visible")
        ) {
          saveSong();
        }
      });

      // ============ Initialize ============
      loadSongs();
      updateDisplayColors();
      updateDisplayText();
      adjustTextareaHeight();
    </script>
  </body>
</html>
